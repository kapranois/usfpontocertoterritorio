{% extends "base.html" %}

{% block title %}Mapa de Territorialização - {{ nome_equipe }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
    /* Estilos para a página de mapa */
    .map-page {
        padding: 20px;
        height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .map-header {
        margin-bottom: 20px;
    }

        .map-header h1 {
            color: #2c3e50;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .map-header p {
            color: #7f8c8d;
            font-size: 14px;
        }

    .map-container {
        display: flex;
        flex: 1;
        gap: 20px;
        height: 100%;
    }

    #map {
        flex: 1;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        height: 100%;
    }

    .map-sidebar {
        width: 350px;
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .map-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }

    .map-section-title {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .map-controls {
        display: grid;
        gap: 10px;
    }

    .map-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
    }

        .map-btn:hover {
            background: #2980b9;
        }

    .map-btn-secondary {
        background: #95a5a6;
    }

        .map-btn-secondary:hover {
            background: #7f8c8d;
        }

    .map-btn-danger {
        background: #e74c3c;
    }

        .map-btn-danger:hover {
            background: #c0392b;
        }

    .map-btn-success {
        background: #27ae60;
    }

        .map-btn-success:hover {
            background: #219653;
        }

    .color-picker {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
        margin: 10px 0;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
    }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #2c3e50;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

    .form-group {
        margin-bottom: 15px;
    }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #495057;
            font-weight: 500;
        }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

    textarea.form-control {
        min-height: 80px;
        resize: vertical;
    }

    .areas-list {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .area-item {
        background: #ffffff;
        border-radius: 8px;
        padding: 12px;
        border-left: 4px solid #3498db;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

        .area-item:hover {
            background: #f1f8ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

    .area-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }

    .area-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
    }

    .area-type {
        font-size: 12px;
        color: #7f8c8d;
        background: #ecf0f1;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .area-actions {
        display: flex;
        gap: 5px;
        margin-top: 8px;
    }

    .area-action-btn {
        background: none;
        border: none;
        color: #7f8c8d;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: all 0.2s;
        font-size: 14px;
    }

        .area-action-btn:hover {
            background: #dfe6e9;
            color: #2c3e50;
        }

        .area-action-btn i {
            font-size: 14px;
        }

    .area-description {
        font-size: 13px;
        color: #636e72;
        margin-top: 5px;
        line-height: 1.4;
    }

    .no-areas {
        text-align: center;
        padding: 40px 20px;
        color: #7f8c8d;
    }

        .no-areas i {
            font-size: 48px;
            margin-bottom: 10px;
            color: #bdc3c7;
        }

    /* Botão de tela cheia */
    #fullscreen-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: all 0.3s;
    }

        #fullscreen-toggle:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

    /* Estilos para modo tela cheia */
    .modo-tela-cheia {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
    }

        .modo-tela-cheia .map-container {
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .modo-tela-cheia #map {
            width: 100% !important;
            height: 100% !important;
            border-radius: 0 !important;
        }

        .modo-tela-cheia .map-sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            z-index: 10000;
            margin: 0;
            border-radius: 0;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }

        .modo-tela-cheia .map-header,
        .modo-tela-cheia .footer,
        .modo-tela-cheia .header {
            display: none !important;
        }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 25px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }

    .modal-header {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 15px;
    }

    .modal-footer {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
    }

    /* Controles do mapa */
    .leaflet-top.leaflet-left {
        top: 90px;
        left: 10px;
    }

    .leaflet-draw-toolbar {
        margin-top: 10px;
    }

    /* Responsivo */
    @media (max-width: 1024px) {
        .map-container {
            flex-direction: column;
            height: calc(100vh - 200px);
        }

        .map-sidebar {
            width: 100%;
            height: 300px;
            order: 2;
        }

        #map {
            height: 400px;
            order: 1;
        }

        #fullscreen-toggle {
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            font-size: 12px;
        }
    }

    @media (max-width: 768px) {
        .map-page {
            padding: 10px;
            height: calc(100vh - 120px);
        }

        .area-actions {
            flex-wrap: wrap;
        }

        .area-action-btn {
            padding: 3px;
        }

        .modo-tela-cheia .map-sidebar {
            width: 100%;
            height: 40vh;
            bottom: 0;
            top: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="map-page">
    <!-- Cabeçalho da página -->
    <div class="map-header">
        <h1>
            <i class="fas fa-map-marked-alt"></i>
            Mapa de Territorialização
        </h1>
        <p>Visualize e edite áreas de atuação da equipe {{ nome_equipe }}</p>
    </div>

    <!-- Botão tela cheia -->
    <button id="fullscreen-toggle">
        <i class="fas fa-expand"></i>
        <span class="btn-text">Tela Cheia</span>
    </button>

    <div class="map-container">
        <!-- Sidebar com controles -->
        <div class="map-sidebar">
            <!-- Ferramentas de desenho -->
            <div class="map-section">
                <div class="map-section-title">
                    <i class="fas fa-draw-polygon"></i>
                    Ferramentas de Desenho
                </div>
                <div class="map-controls">
                    <button class="map-btn" id="btn-draw-polygon">
                        <i class="fas fa-draw-polygon"></i>

                        Desenhar Polígono
                    </button>
                    <button class="map-btn" id="btn-draw-rectangle">
                        <i class="fas fa-vector-square"></i>
                        Desenhar Retângulo
                    </button>
                    <button class="map-btn" id="btn-draw-circle">
                        <i class="fas fa-circle"></i>
                        Desenhar Círculo
                    </button>
                    <button class="map-btn map-btn-secondary" id="btn-edit">
                        <i class="fas fa-edit"></i>
                        Editar Área
                    </button>
                    <button class="map-btn map-btn-danger" id="btn-delete">
                        <i class="fas fa-trash"></i>
                        Excluir Área
                    </button>
                </div>
            </div>

            <!-- Propriedades da área -->
            <div class="map-section">
                <div class="map-section-title">
                    <i class="fas fa-palette"></i>
                    Propriedades da Área
                </div>

                <div class="form-group">
                    <label for="area-name">Nome da Área:</label>
                    <input type="text" id="area-name" class="form-control" placeholder="Ex: Bairro Centro">
                </div>

                <div class="form-group">
                    <label for="area-type">Tipo:</label>
                    <select id="area-type" class="form-control">
                        <option value="bairro">Bairro</option>
                        <option value="comunidade">Comunidade</option>
                        <option value="microarea">Microárea</option>
                        <option value="setor">Setor</option>
                        <option value="condominio">Condomínio</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Cor da Área:</label>
                    <div class="color-picker" id="color-picker">
                        <!-- Cores serão geradas pelo JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label for="area-description">Descrição:</label>
                    <textarea id="area-description" class="form-control" placeholder="Descreva a área..."></textarea>
                </div>

                <div class="form-group">
                    <label for="agente-id">Agente Responsável:</label>
                    <input type="text" id="agente-id" class="form-control" placeholder="Nome do agente (opcional)">
                </div>
                <div class="form-group">
                    <label for="streetview-link">
                        <i class="fas fa-street-view"></i>
                        Link do Street View/Google Earth
                    </label>
                    <input type="url" id="streetview-link" class="form-control"
                           placeholder="Cole o link do Google Earth ou Street View aqui">
                    <small class="form-text" style="color: #666; font-size: 12px; margin-top: 5px;">
                        Cole um link do Google Earth ou Street View para visualização imersiva
                    </small>
                </div>

                <button class="map-btn map-btn-success" id="btn-save-area">
                    <i class="fas fa-save"></i>
                    Salvar Área
                </button>

                <button class="map-btn map-btn-secondary" id="btn-clear-form">
                    <i class="fas fa-times"></i>
                    Limpar Formulário
                </button>
            </div>

            <!-- Áreas salvas -->
            <div class="map-section" style="flex: 1;">
                <div class="map-section-title">
                    <i class="fas fa-layer-group"></i>
                    Áreas Salvas
                    <span class="badge" id="areas-count" style="background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                </div>
                <div class="areas-list" id="areas-list">
                    <!-- Áreas serão carregadas aqui -->
                    <div class="no-areas">
                        <i class="fas fa-map"></i>
                        <p>Nenhuma área salva ainda.<br>Desenhe uma área no mapa!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapa -->
        <div id="map"></div>
    </div>
</div>

<!-- Modal de confirmação -->
<div class="modal" id="confirm-modal">
    <div class="modal-content">
        <div class="modal-header">Confirmar Exclusão</div>
        <p>Tem certeza que deseja excluir esta área?</p>
        <div class="modal-footer">
            <button class="map-btn map-btn-danger" id="btn-confirm-delete">Excluir</button>
            <button class="map-btn map-btn-secondary" id="btn-cancel-delete">Cancelar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
    // Configuração inicial
    window.APP_CONFIG = window.APP_CONFIG || {
        nivel_usuario: '{{ nivel_usuario }}',
        usuario_logado: {{ 'true' if usuario_logado else 'false' }},
        nome_equipe: '{{ nome_equipe }}'
    };
 <script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css" />

<!-- Para geolocalização -->
<script src="https://unpkg.com/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.css" />

<!-- Para exportar como imagem (opcional) -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</script>
<script src="{{ url_for('static', filename='js/mapa.js') }}"></script>
{% endblock %}
