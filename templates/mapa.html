{% extends "base.html" %}

{% block title %}Mapa de Territorialização - {{ nome_equipe }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/mapa.css') }}">
{% endblock %}

{% block content %}
<div class="map-page">
    <!-- Cabeçalho da página -->
    <div class="map-header">
        <h1>
            <i class="fas fa-map-marked-alt"></i>
            Territorialização
        </h1>
        <p>Áreas de atuação da {{ nome_equipe }}</p>
    </div>

    <!-- Botão tela cheia -->
    <button id="fullscreen-toggle">
        <i class="fas fa-expand"></i>
        <span class="btn-text"></span>
    </button>

    <!-- Botão flutuante para criar mapa -->
    <div class="floating-create-btn" id="floating-create-btn">
        <button class="create-btn" id="btn-create-map">
            <i class="fas fa-plus"></i>
            <span>Criar Mapa</span>
        </button>
        <div class="tooltip">
            Clique aqui para começar a desenhar uma nova área
        </div>
    </div>
        <!-- Card de informações da área (inicialmente oculto) -->
        <div class="area-info-card" id="area-info-card">
            <div class="card-header">
                <h4 id="card-area-name">Nome da Área</h4>
                <button class="close-card" id="close-card">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-content">
                <div class="card-info-row">
                    <span class="card-label">Tipo:</span>
                    <span class="card-value" id="card-area-type">Bairro</span>
                </div>
                <div class="card-info-row">
                    <span class="card-label">Status:</span>
                    <span class="card-value" id="card-area-status">Descoberta</span>
                </div>
                <div class="card-info-row">
                    <span class="card-label">Descrição:</span>
                    <span class="card-value" id="card-area-description">Sem descrição</span>
                </div>
                <div class="card-info-row" id="card-agente-row" style="display: none;">
                    <span class="card-label">Agente:</span>
                    <span class="card-value" id="card-area-agente">-</span>
                </div>
                <div class="card-info-row" id="card-streetview-row" style="display: none;">
                    <span class="card-label">Street View:</span>
                    <a href="#" target="_blank" id="card-streetview-link" class="card-link">Ver no mapa</a>
                </div>

                <!-- Botão de edição (apenas ícone) -->
                <div class="card-actions">
                    <button class="card-edit-btn" id="card-edit-btn" title="Editar esta área">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    <

    <div class="map-container">
        <!-- Container do Mapa -->
        <div id="map"></div>

        <!-- Popup de edição (inicialmente oculto) -->
        <div class="edit-popup" id="edit-popup">
            <div class="popup-header">
                <h3><i class="fas fa-edit"></i> Editar Área</h3>
                <button class="close-popup" id="close-popup">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Ferramentas de edição (ícone de lápis que expande) -->
            <div class="popup-content">
                <div class="edit-tools-collapsed">
                    <button class="edit-tools-toggle" id="edit-tools-toggle">
                        <i class="fas fa-pencil-alt"></i>
                        Ferramentas de Edição
                    </button>
                </div>

                <div class="edit-tools-expanded" id="edit-tools-expanded" style="display: none;">
                    <div class="tool-group">
                        <h4><i class="fas fa-draw-polygon"></i> Desenho</h4>
                        <div class="draw-buttons">
                            <button class="draw-btn active" data-type="polygon" title="Desenhar área livre">
                                <i class="fas fa-draw-polygon"></i>
                                <span>Polígono Livre</span>
                            </button>
                        </div>
                    </div>

                    <div class="tool-group">
                        <h4><i class="fas fa-edit"></i> Editar Forma</h4>
                        <div class="edit-buttons">
                            <button class="edit-btn" id="btn-edit-shape" title="Modificar vértices">
                                <i class="fas fa-vector-square"></i>
                                <span>Editar Forma</span>
                            </button>
                            <button class="edit-btn" id="btn-delete-shape" title="Excluir área">
                                <i class="fas fa-trash"></i>
                                <span>Excluir</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Informações da área -->
                <div class="area-info-section">
                    <h4><i class="fas fa-info-circle"></i> Informações da Área</h4>

                    <div class="form-group">
                        <label for="area-name-popup">Nome da Área:</label>
                        <input type="text" id="area-name-popup" class="form-control"
                               placeholder="Digite o nome da área (opcional)">
                    </div>

                    <div class="form-group">
                        <label for="area-type-popup">Tipo:</label>
                        <select id="area-type-popup" class="form-control">
                            <option value="bairro">Bairro</option>
                            <option value="condominio">Condomínio</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Cor da Área:</label>
                        <div class="color-picker" id="color-picker-popup">
                            <!-- Cores serão geradas pelo JavaScript -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="area-description-popup">Descrição:</label>
                        <textarea id="area-description-popup" class="form-control"
                                  placeholder="Descreva a área (opcional)..." rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="agente-id-popup">
                            <i class="fas fa-user-md"></i>
                            Agente Responsável :
                        </label>
                        <input type="text" id="agente-id-popup" class="form-control"
                               placeholder="Nome do agente">
                    </div>

                    <div class="form-group">
                        <label for="streetview-link-popup">
                            <i class="fas fa-street-view"></i>
                            Link do Street View/Google Earth
                        </label>
                        <input type="url" id="streetview-link-popup" class="form-control"
                               placeholder="Cole o link do Google Earth ou Street View">
                    </div>
                </div>

                <!-- Botões de ação -->
                <div class="popup-actions">
                    <button class="popup-btn popup-btn-success" id="btn-save-popup">
                        <i class="fas fa-check"></i>
                        Concluir
                    </button>
                    <button class="popup-btn popup-btn-danger" id="btn-delete-popup">
                        <i class="fas fa-times"></i>
                        Deletar
                    </button>
                </div>
            </div>
        </div>

        <!-- Overlay para quando o popup estiver aberto -->
        <div class="popup-overlay" id="popup-overlay"></div>
    </div>
</div>

<!-- Modal de confirmação para exclusão -->
<div class="modal" id="confirm-modal">
    <div class="modal-content">
        <div class="modal-header">
            <i class="fas fa-exclamation-triangle"></i>
            Confirmar Exclusão
        </div>
        <p>Tem certeza que deseja excluir esta área?</p>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-danger" id="btn-confirm-delete">Excluir</button>
            <button class="modal-btn modal-btn-secondary" id="btn-cancel-delete">Cancelar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
    // Configuração inicial
    window.APP_CONFIG = window.APP_CONFIG || {
        //nivel_usuario: '{{ nivel_usuario }}',
        usuario_logado: {{ 'true' if usuario_logado else 'false' }},
        nome_equipe: '{{ nome_equipe }}'
    };
</script>
<script src="{{ url_for('static', filename='js/mapa.js') }}"></script>
{% endblock %}

