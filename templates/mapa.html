{% extends "base.html" %}

{% block title %}Mapa de Territorialização - {{ nome_equipe }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/mapa.css') }}">
{% endblock %}

{% block content %}
<div class="map-page">
    <!-- Cabeçalho da página -->
    <div class="map-header">
        <h1>
            <i class="fas fa-map-marked-alt"></i>
            Mapa de Territorialização
        </h1>
        <p>Visualize e edite áreas de atuação da equipe {{ nome_equipe }}</p>
    </div>

    <!-- Botão tela cheia -->
    <button id="fullscreen-toggle">
        <i class="fas fa-expand"></i>
        <span class="btn-text">Tela Cheia</span>
    </button>

    <div class="map-container">
        <!-- Container do Mapa -->
        <div id="map"></div>

        <!-- Sidebar com controles -->
        <div class="map-sidebar">
            <!-- Ferramentas de desenho -->
            <div class="map-section">
                <div class="map-section-title">
                    <i class="fas fa-draw-polygon"></i>
                    Ferramentas de Desenho
                </div>
                <div class="map-toolbar">
                    <button id="btn-draw-polygon" title="Desenhar área livre">
                        <i class="fas fa-draw-polygon"></i>
                    </button>
                    <button id="btn-draw-rectangle" title="Desenhar área retangular">
                        <i class="fas fa-vector-square"></i>
                    </button>
                    <button id="btn-draw-circle" title="Desenhar área circular">
                        <i class="fas fa-circle"></i>
                    </button>
                    <button id="btn-edit" title="Editar área existente">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button id="btn-delete" title="Excluir área">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Propriedades da área -->
            <div class="map-section">
                <div class="map-section-title">
                    <i class="fas fa-palette"></i>
                    Propriedades da Área
                </div>

                <div class="form-group">
                    <label for="area-name">Nome da Área:</label>
                    <input type="text" id="area-name" class="form-control" placeholder="Ex: Bairro Centro">
                </div>

                <div class="form-group">
                    <label for="area-type">Tipo:</label>
                    <select id="area-type" class="form-control">
                        <option value="bairro">Bairro</option>
                        <option value="comunidade">Comunidade</option>
                        <option value="microarea">Microárea</option>
                        <option value="setor">Setor</option>
                        <option value="condominio">Condomínio</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Cor da Área:</label>
                    <div class="color-picker" id="color-picker">
                        <!-- Cores serão geradas pelo JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label for="area-description">Descrição:</label>
                    <textarea id="area-description" class="form-control" placeholder="Descreva a área..."></textarea>
                </div>

                <div class="form-group">
                    <label for="agente-id">Agente Responsável:</label>
                    <input type="text" id="agente-id" class="form-control" placeholder="Nome do agente (opcional)">
                </div>

                <div class="form-group">
                    <label for="streetview-link">
                        <i class="fas fa-street-view"></i>
                        Link do Street View/Google Earth
                    </label>
                    <input type="url" id="streetview-link" class="form-control"
                           placeholder="Cole o link do Google Earth ou Street View aqui">
                    <small class="form-text" style="color: #666; font-size: 12px; margin-top: 5px;">
                        Cole um link do Google Earth ou Street View para visualização imersiva
                    </small>
                </div>

                <button class="map-btn map-btn-success" id="btn-save-area">
                    <i class="fas fa-save"></i>
                    Salvar Área
                </button>

                <button class="map-btn map-btn-secondary" id="btn-clear-form">
                    <i class="fas fa-times"></i>
                    Limpar Formulário
                </button>
            </div>

            <!-- Áreas salvas -->
            <div class="map-section" style="flex: 1;">
                <div class="map-section-title">
                    <i class="fas fa-layer-group"></i>
                    Áreas Salvas
                    <span class="badge" id="areas-count" style="background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                </div>
                <div class="areas-list" id="areas-list">
                    <!-- Áreas serão carregadas aqui -->
                    <div class="no-areas">
                        <i class="fas fa-map"></i>
                        <p>Nenhuma área salva ainda.<br>Desenhe uma área no mapa!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmação -->
<div class="modal" id="confirm-modal">
    <div class="modal-content">
        <div class="modal-header">Confirmar Exclusão</div>
        <p>Tem certeza que deseja excluir esta área?</p>
        <div class="modal-footer">
            <button class="map-btn map-btn-danger" id="btn-confirm-delete">Excluir</button>
            <button class="map-btn map-btn-secondary" id="btn-cancel-delete">Cancelar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
    // Configuração inicial
    window.APP_CONFIG = window.APP_CONFIG || {
        nivel_usuario: '{{ nivel_usuario }}',
        usuario_logado: {{ 'true' if usuario_logado else 'false' }},
        nome_equipe: '{{ nome_equipe }}'
    };
</script>
<script src="{{ url_for('static', filename='js/mapa.js') }}"></script>
{% endblock %}
