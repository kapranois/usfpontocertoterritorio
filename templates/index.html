<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.5, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>{{ nome_equipe }} - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos específicos para o modal multi-etapa */
        .form-step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

            .form-step:last-child {
                border-bottom: none;
            }

            .form-step h4 {
                color: #2c3e50;
                margin-bottom: 20px;
                font-size: 1.1rem;
                display: flex;
                align-items: center;
                gap: 10px;
            }

                .form-step h4 i {
                    color: #1a73e8;
                }

        .cobertura-option {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .radio-option {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

            .radio-option:hover {
                border-color: #1a73e8;
                background: #f0f7ff;
            }

            .radio-option input[type="radio"] {
                display: none;
            }

                .radio-option input[type="radio"]:checked + .radio-content {
                    color: #1a73e8;
                }

        .radio-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

            .radio-content i {
                font-size: 1.5rem;
                color: #666;
            }

        .radio-option input[type="radio"]:checked + .radio-content i {
            color: #1a73e8;
        }

        .radio-content div {
            flex: 1;
        }

        .radio-content strong {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .radio-content small {
            color: #666;
            font-size: 0.85rem;
        }

        .cobertura-display {
            margin-top: 10px;
        }

        .cobertura-visual {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .cobertura-bar {
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            margin-bottom: 10px;
            background: #f0f0f0;
        }

        .coberto {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            height: 100%;
            transition: width 0.5s ease;
        }

        .descoberto {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            height: 100%;
            transition: width 0.5s ease;
        }

        .cobertura-numbers {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

            .cobertura-numbers span:first-child {
                color: #27ae60;
                font-weight: 500;
            }

            .cobertura-numbers span:last-child {
                color: #e74c3c;
                font-weight: 500;
            }

        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-prev, .btn-next {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-prev {
            background: #95a5a6;
            color: white;
        }

            .btn-prev:hover {
                background: #7f8c8d;
                transform: translateY(-2px);
            }

        .btn-next {
            background: #1a73e8;
            color: white;
        }

            .btn-next:hover {
                background: #0d47a1;
                transform: translateY(-2px);
            }

        .range-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

            .range-display input[type="range"] {
                flex: 1;
                height: 6px;
                border-radius: 3px;
                background: #e0e0e0;
                outline: none;
            }

                .range-display input[type="range"]::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: #1a73e8;
                    cursor: pointer;
                }

        /* Estilos para badges de status no card */
        .condominio-badges {
            display: flex;
            gap: 8px;
        }

        .badge.status-completo {
            background: #2ecc71;
            color: white;
        }

        .badge.status-parcial {
            background: #f39c12;
            color: white;
        }

        .badge.status-descoberto {
            background: #e74c3c;
            color: white;
        }

        /* Barra de cobertura no card */
        .cobertura-condominio {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .cobertura-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .cobertura-barra {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            margin-bottom: 5px;
        }

            .cobertura-barra .coberto {
                background: #2ecc71;
                height: 100%;
            }

            .cobertura-barra .descoberto {
                background: #e74c3c;
                height: 100%;
            }

        .cobertura-percent {
            text-align: right;
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
        }

        /* Cores para cards por status */
        .condominio-card.status-completo {
            border-left: 5px solid #2ecc71;
        }

        .condominio-card.status-parcial {
            border-left: 5px solid #f39c12;
        }

        .condominio-card.status-descoberto {
            border-left: 5px solid #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho CORRIGIDO - apenas UM header-right -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-map-marked-alt"></i>
                <div>
                    <h1>{{ nome_equipe }}</h1>
                    <p class="subtitle">Dashboard de Territorialização</p>
                </div>
            </div>
            <div class="header-right">
                <div class="equipe-info">
                    <i class="fas fa-users"></i> {{ nome_equipe }}
                </div>
                {% if usuario_logado %}
                <div class="user-info">
                    <i class="fas fa-user-circle"></i> {{ nome_usuario }}
                </div>
                {% endif %}
                <nav class="navbar">
                    <a href="/dashboard" class="active"><i class="fas fa-home"></i> Início</a>
                    <a href="/mapa"><i class="fas fa-map"></i> Mapa</a>
                    <a href="/condominios"><i class="fas fa-building"></i> Condomínios</a>
                    <a href="/relatorios"><i class="fas fa-chart-bar"></i> Relatórios</a>
                    {% if usuario_logado %}
                    <a href="/trocar-equipe" class="btn-sair"><i class="fas fa-exchange-alt"></i> Trocar Equipe</a>
                    <a href="/logout" class="btn-sair" style="background: #e74c3c;">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </a>
                    {% else %}
                    <a href="/login" class="btn-sair"><i class="fas fa-sign-in-alt"></i> Login</a>
                    {% endif %}
                </nav>
            </div>
        </header>

        <!-- Métricas -->
        <section class="metrics">
            <h2><i class="fas fa-chart-line"></i> Resumo do Território</h2>
            <div class="metrics-grid">
                <div class="metric-card card-total">
                    <div class="metric-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metric-info">
                        <h3>Total de Moradores</h3>
                        <p class="metric-value">{{ metricas.total_moradores }}</p>
                    </div>
                </div>

                <div class="metric-card card-hipertensos">
                    <div class="metric-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="metric-info">
                        <h3>Hipertensos</h3>
                        <p class="metric-value">{{ metricas.total_hipertensos }}</p>
                    </div>
                </div>

                <div class="metric-card card-diabeticos">
                    <div class="metric-icon">
                        <i class="fas fa-prescription-bottle"></i>
                    </div>
                    <div class="metric-info">
                        <h3>Diabéticos</h3>
                        <p class="metric-value">{{ metricas.total_diabeticos }}</p>
                    </div>
                </div>

                <div class="metric-card card-gestantes">
                    <div class="metric-icon">
                        <i class="fas fa-female"></i>
                    </div>
                    <div class="metric-info">
                        <h3>Gestantes</h3>
                        <p class="metric-value">{{ metricas.total_gestantes }}</p>
                    </div>
                </div>

                <div class="metric-card card-cobertura">
                    <div class="metric-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="metric-info">
                        <h3>Cobertura Geral</h3>
                        <p class="metric-value">{{ metricas.cobertura_geral|default(0) }}%</p>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ metricas.cobertura_geral|default(0) }}%"></div>
                        </div>
                    </div>
                </div>

                <!-- Nova métrica: Condomínios Cobertos -->
                <div class="metric-card card-status">
                    <div class="metric-icon" style="background: #2ecc71;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="metric-info">
                        <h3>Cobertos</h3>
                        <p class="metric-value">
                            {% set cobertos = condominios|selectattr('status_cobertura', 'equalto', 'completo')|list|length %}
                            {{ cobertos }}
                        </p>
                    </div>
                </div>

                <!-- Nova métrica: Condomínios Parciais -->
                <div class="metric-card card-status">
                    <div class="metric-icon" style="background: #f39c12;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="metric-info">
                        <h3>Parciais</h3>
                        <p class="metric-value">
                            {% set parciais = condominios|selectattr('status_cobertura', 'equalto', 'parcial')|list|length %}
                            {{ parciais }}
                        </p>
                    </div>
                </div>

                <!-- Nova métrica: Condomínios Descobertos -->
                <div class="metric-card card-status">
                    <div class="metric-icon" style="background: #e74c3c;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="metric-info">
                        <h3>Descobertos</h3>
                        <p class="metric-value">
                            {% set descobertos = condominios|selectattr('status_cobertura', 'equalto', 'descoberto')|list|length %}
                            {{ descobertos }}
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Condomínios -->
        <section class="condominios">
            <div class="section-header">
                <h2><i class="fas fa-building"></i> Condomínios do Território</h2>
                <div class="section-actions">
                    {% if usuario_logado %}
                    <button class="btn-add" onclick="mostrarModal()">
                        <i class="fas fa-plus"></i> Novo Condomínio
                    </button>
                    {% else %}
                    <button class="btn-add disabled" onclick="alert('Faça login para adicionar condomínios'); window.location.href='/login';"
                            style="position: relative;">
                        <i class="fas fa-plus"></i> Novo Condomínio
                        <span style="position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                            <i class="fas fa-lock"></i>
                        </span>
                    </button>
                    {% endif %}
                </div>
            </div>

            {% if condominios %}
            <div class="condominios-grid">
                {% for cond in condominios %}
                <div class="condominio-card priority-{{ cond.prioridade }} status-{{ cond.status_cobertura }}">
                    <div class="condominio-header">
                        <h3>{{ cond.nome }}</h3>
                        <div class="condominio-badges">
                            <span class="badge priority-{{ cond.prioridade }}">
                                {{ cond.prioridade|upper }}
                            </span>
                            <span class="badge status-{{ cond.status_cobertura }}">
                                {% if cond.status_cobertura == 'completo' %}
                                <i class="fas fa-check-circle"></i> COBERTO
                                {% elif cond.status_cobertura == 'parcial' %}
                                <i class="fas fa-exclamation-triangle"></i> PARCIAL
                                {% else %}
                                <i class="fas fa-times-circle"></i> DESCOBERTO
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <div class="condominio-info">
                        <!-- Informações básicas -->
                        <div class="info-item">
                            <i class="fas fa-layer-group"></i>
                            <span>{{ cond.torres }} blocos total</span>
                        </div>

                        <div class="info-item">
                            <i class="fas fa-door-closed"></i>
                            <span>{{ cond.apartamentos }} apartamentos</span>
                        </div>

                        <div class="info-item">
                            <i class="fas fa-users"></i>
                            <span>{{ cond.moradores }} moradores</span>
                        </div>

                        <!-- Cobertura por ACS -->
                        <div class="info-item">
                            <i class="fas fa-user-md"></i>
                            <span>
                                {% if cond.acs_responsavel %}
                                ACS: {{ cond.acs_responsavel }}
                                {% else %}
                                Sem ACS alocado
                                {% endif %}
                            </span>
                        </div>

                        <!-- Blocos cobertos vs descobertos -->
                        <div class="info-item">
                            <i class="fas fa-check-circle" style="color: #27ae60;"></i>
                            <span>{{ cond.blocos_cobertos }} blocos cobertos</span>
                        </div>

                        <div class="info-item">
                            <i class="fas fa-times-circle" style="color: #e74c3c;"></i>
                            <span>{{ cond.blocos_descobertos }} blocos descobertos</span>
                        </div>

                        <!-- Dados de saúde -->
                        <div class="info-item">
                            <i class="fas fa-heartbeat" style="color: #e74c3c;"></i>
                            <span>{{ cond.hipertensos }} hipertensos</span>
                        </div>

                        <div class="info-item">
                            <i class="fas fa-prescription-bottle" style="color: #f39c12;"></i>
                            <span>{{ cond.diabeticos }} diabéticos</span>
                        </div>

                        <div class="info-item">
                            <i class="fas fa-female" style="color: #9b59b6;"></i>
                            <span>{{ cond.gestantes }} gestantes</span>
                        </div>

                        <!-- Barra de cobertura -->
                        <div class="cobertura-condominio">
                            <div class="cobertura-label">Cobertura de Blocos:</div>
                            <div class="cobertura-barra">
                                <div class="coberto" style="width: {{ cond.cobertura }}%"></div>
                                <div class="descoberto" style="width: {{ 100 - cond.cobertura }}%"></div>
                            </div>
                            <div class="cobertura-percent">{{ cond.cobertura }}%</div>
                        </div>
                    </div>

                    <div class="condominio-footer">
                        <div class="cobertura-info">
                            <span>Última visita: {{ cond.ultima_visita }}</span>
                        </div>
                        <div class="ultima-visita">
                            <i class="far fa-calendar"></i>
                            <span>{{ cond.ultima_visita }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-building fa-3x"></i>
                <h3>Nenhum condomínio cadastrado</h3>
                <p>Adicione condomínios para começar o monitoramento</p>
                {% if usuario_logado %}
                <button class="btn-primary" onclick="mostrarModal()">
                    <i class="fas fa-plus"></i> Adicionar Primeiro Condomínio
                </button>
                {% else %}
                <button class="btn-primary" onclick="alert('Faça login para adicionar condomínios'); window.location.href='/login';">
                    <i class="fas fa-plus"></i> Adicionar Primeiro Condomínio
                    <span style="margin-left: 8px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">
                        <i class="fas fa-lock"></i> Login necessário
                    </span>
                </button>
                {% endif %}
            </div>
            {% endif %}
        </section>

        <!-- Modal para Adicionar Condomínio -->
        <div id="modalCondominio" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3><i class="fas fa-plus-circle"></i> Cadastrar Novo Condomínio</h3>
                    <span class="close" onclick="fecharModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="formCondominio">
                        <!-- Passo 1: Informações Básicas -->
                        <div class="form-step" id="step1">
                            <h4><i class="fas fa-info-circle"></i> Informações Básicas</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="nomeCondominio"><i class="fas fa-building"></i> Nome do Condomínio*</label>
                                    <input type="text" id="nomeCondominio" required placeholder="Ex: Condomínio Lucaia">
                                </div>

                                <div class="form-group">
                                    <label for="torres"><i class="fas fa-layer-group"></i> Total de Blocos/Torres*</label>
                                    <input type="number" id="torres" min="1" required placeholder="Ex: 23" onchange="calcularCobertura()">
                                </div>

                                <div class="form-group">
                                    <label for="apartamentos"><i class="fas fa-door-closed"></i> Total de Apartamentos*</label>
                                    <input type="number" id="apartamentos" min="1" required placeholder="Ex: 460">
                                </div>

                                <div class="form-group">
                                    <label for="moradores"><i class="fas fa-users"></i> Total de Moradores*</label>
                                    <input type="number" id="moradores" min="1" required placeholder="Ex: 1610">
                                </div>
                            </div>
                        </div>

                        <!-- Passo 2: Cobertura por ACS -->
                        <div class="form-step" id="step2" style="display: none;">
                            <h4><i class="fas fa-user-nurse"></i> Cobertura por ACS</h4>

                            <div class="cobertura-option">
                                <label class="radio-option">
                                    <input type="radio" name="tem_acs" value="sim" checked onchange="toggleACSInfo(true)">
                                    <div class="radio-content">
                                        <i class="fas fa-user-check"></i>
                                        <div>
                                            <strong>Condomínio com ACS</strong>
                                            <small>Existe ACS trabalhando neste condomínio</small>
                                        </div>
                                    </div>
                                </label>

                                <label class="radio-option">
                                    <input type="radio" name="tem_acs" value="nao" onchange="toggleACSInfo(false)">
                                    <div class="radio-content">
                                        <i class="fas fa-user-times"></i>
                                        <div>
                                            <strong>Condomínio Descoberto</strong>
                                            <small>Não há ACS trabalhando neste condomínio</small>
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <!-- Informações do ACS (aparece apenas se tem ACS) -->
                            <div id="acsInfo" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="nomeACS"><i class="fas fa-user-md"></i> Nome do ACS*</label>
                                        <input type="text" id="nomeACS" placeholder="Ex: Maria Silva">
                                    </div>

                                    <div class="form-group">
                                        <label for="blocosCobertos"><i class="fas fa-map-marked-alt"></i> Blocos Atendidos*</label>
                                        <input type="text" id="blocosCobertos" placeholder="Ex: 1-13 ou 1,2,3,5-8" onchange="calcularCobertura()">
                                        <small style="color: #666; font-size: 0.85rem;">Informe os blocos que o ACS atende</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="blocosDescobertos"><i class="fas fa-map-marked"></i> Blocos Descobertos</label>
                                        <input type="text" id="blocosDescobertos" placeholder="Será calculado automaticamente" readonly>
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-chart-pie"></i> Cobertura de Blocos</label>
                                        <div class="cobertura-display">
                                            <div class="cobertura-visual">
                                                <div class="cobertura-bar">
                                                    <div class="coberto" id="cobertoBar" style="width: 0%"></div>
                                                    <div class="descoberto" id="descobertoBar" style="width: 100%"></div>
                                                </div>
                                                <div class="cobertura-numbers">
                                                    <span id="cobertoText">0 blocos cobertos (0%)</span>
                                                    <span id="descobertoText">0 blocos descobertos (0%)</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Passo 3: Dados de Saúde -->
                        <div class="form-step" id="step3" style="display: none;">
                            <h4><i class="fas fa-heartbeat"></i> Dados de Saúde</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="hipertensos"><i class="fas fa-heartbeat"></i> Hipertensos</label>
                                    <input type="number" id="hipertensos" min="0" value="0" placeholder="0">
                                </div>

                                <div class="form-group">
                                    <label for="diabeticos"><i class="fas fa-prescription-bottle"></i> Diabéticos</label>
                                    <input type="number" id="diabeticos" min="0" value="0" placeholder="0">
                                </div>

                                <div class="form-group">
                                    <label for="gestantes"><i class="fas fa-female"></i> Gestantes</label>
                                    <input type="number" id="gestantes" min="0" value="0" placeholder="0">
                                </div>

                                <div class="form-group">
                                    <label for="prioridade"><i class="fas fa-exclamation-circle"></i> Prioridade</label>
                                    <select id="prioridade" required>
                                        <option value="baixa">Baixa</option>
                                        <option value="media" selected>Média</option>
                                        <option value="alta">Alta</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Navegação entre passos -->
                        <div class="form-navigation">
                            <button type="button" class="btn-prev" onclick="prevStep()" style="display: none;">
                                <i class="fas fa-arrow-left"></i> Anterior
                            </button>
                            <button type="button" class="btn-next" onclick="nextStep()">
                                Próximo <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>

                        <!-- Botões finais -->
                        <div class="form-actions" id="finalActions" style="display: none;">
                            <button type="button" class="btn-cancelar" onclick="fecharModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn-salvar">
                                <i class="fas fa-save"></i> Salvar Condomínio
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Rodapé -->
        <footer class="footer">
            <p>© 2024 Territorialização USF | {{ nome_equipe }}</p>
            <p class="version">Sistema v1.0 | Última atualização: <span id="currentDate"></span></p>
        </footer>
    </div>

    <!-- Primeiro: Passar variáveis do template para JavaScript -->
    <script>
        // Variáveis globais para verificar login
        window.USUARIO_LOGADO = {% if usuario_logado %}true{% else %}false{% endif %};
        window.NOME_USUARIO = "{{ nome_usuario|default('Visitante') }}";

        console.log('DEBUG TEMPLATE: usuario_logado =', {% if usuario_logado %}true{% else %}false{% endif %});
        console.log('DEBUG TEMPLATE: nome_usuario =', "{{ nome_usuario|default('') }}");
        console.log('DEBUG TEMPLATE: USUARIO_LOGADO =', window.USUARIO_LOGADO);
    </script>

    <!-- Segundo: Carregar o script.js principal -->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    <!-- Terceiro: Scripts específicos da página -->
    <script>
        // Data atual
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR');

        // Animações de entrada
        document.addEventListener('DOMContentLoaded', function () {
            const cards = document.querySelectorAll('.metric-card, .condominio-card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                card.classList.add('fade-in');
            });

            // Verificar se a função mostrarModal foi carregada
            console.log('DEBUG: mostrarModal carregada?', typeof mostrarModal);
        });

        // ============================================
        // SOBRESCREVER FUNÇÃO mostrarModal PARA VERIFICAR LOGIN
        // ============================================
        (function () {
            // Guardar a função original
            var mostrarModalOriginal = window.mostrarModal;

            if (typeof mostrarModalOriginal === 'function') {
                // Criar nova função com verificação de login
                window.mostrarModal = function () {
                    console.log('DEBUG: mostrarModal chamado, USUARIO_LOGADO:', window.USUARIO_LOGADO);

                    if (!window.USUARIO_LOGADO) {
                        alert('Para adicionar um novo condomínio, é necessário fazer login no sistema.');
                        window.location.href = '/login';
                        return false;
                    }

                    // Chamar função original
                    console.log('DEBUG: Chamando função original mostrarModal');
                    return mostrarModalOriginal();
                };

                console.log('DEBUG: mostrarModal sobrescrita com sucesso');
            } else {
                console.error('DEBUG: Função mostrarModal não encontrada para sobrescrever');

                // Se não existe, criar uma básica
                window.mostrarModal = function () {
                    if (!window.USUARIO_LOGADO) {
                        alert('Para adicionar um novo condomínio, é necessário fazer login no sistema.');
                        window.location.href = '/login';
                        return false;
                    }

                    document.getElementById('modalCondominio').style.display = 'block';
                    document.body.style.overflow = 'hidden';

                    // Resetar passos se existir
                    if (typeof resetFormSteps === 'function') {
                        resetFormSteps();
                    }
                };
            }
        })();

        // ============================================
        // FUNÇÕES DO MODAL MULTI-ETAPA (apenas as que não estão no script.js)
        // ============================================

        function mostrarMensagem(tipo, texto) {
            alert(`[${tipo.toUpperCase()}] ${texto}`);
        }

        // ============================================
        // FORM SUBMIT
        // ============================================
        document.addEventListener('DOMContentLoaded', function () {
            // Formulário de envio
            const formCondominio = document.getElementById('formCondominio');
            if (formCondominio) {
                formCondominio.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    // Verificar login antes de enviar
                    if (!window.USUARIO_LOGADO) {
                        alert('Você precisa estar logado para adicionar condomínios.');
                        window.location.href = '/login';
                        return;
                    }

                    const temACS = document.querySelector('input[name="tem_acs"]:checked').value === 'sim';
                    const totalTorres = parseInt(document.getElementById('torres').value) || 0;
                    const blocosCobertosStr = document.getElementById('blocosCobertos').value || '';

                    // Calcular cobertura real
                    let blocosCobertos = 0;
                    let statusCobertura = 'descoberto';

                    if (temACS && blocosCobertosStr) {
                        const partes = blocosCobertosStr.split(',');
                        for (let parte of partes) {
                            parte = parte.trim();
                            if (parte.includes('-')) {
                                const [inicio, fim] = parte.split('-').map(Number);
                                if (!isNaN(inicio) && !isNaN(fim) && inicio <= fim) {
                                    blocosCobertos += (fim - inicio + 1);
                                }
                            } else if (!isNaN(Number(parte))) {
                                blocosCobertos += 1;
                            }
                        }

                        if (blocosCobertos === 0) {
                            statusCobertura = 'descoberto';
                        } else if (blocosCobertos === totalTorres) {
                            statusCobertura = 'completo';
                        } else {
                            statusCobertura = 'parcial';
                        }
                    } else {
                        statusCobertura = 'descoberto';
                    }

                    const percentCobertura = totalTorres > 0 ? Math.round((blocosCobertos / totalTorres) * 100) : 0;

                    const condominio = {
                        nome: document.getElementById('nomeCondominio').value,
                        torres: totalTorres,
                        blocos_cobertos: blocosCobertos,
                        blocos_descobertos: totalTorres - blocosCobertos,
                        acs_responsavel: temACS ? document.getElementById('nomeACS').value : null,
                        blocos_ativos: temACS ? blocosCobertosStr : null,
                        apartamentos: parseInt(document.getElementById('apartamentos').value),
                        moradores: parseInt(document.getElementById('moradores').value),
                        hipertensos: parseInt(document.getElementById('hipertensos').value),
                        diabeticos: parseInt(document.getElementById('diabeticos').value),
                        gestantes: parseInt(document.getElementById('gestantes').value),
                        cobertura: percentCobertura,
                        status_cobertura: statusCobertura,
                        prioridade: document.getElementById('prioridade').value,
                        ultima_visita: new Date().toISOString().split('T')[0]
                    };

                    console.log('DEBUG: Enviando condomínio:', condominio);

                    try {
                        const btnSalvar = this.querySelector('.btn-salvar');
                        btnSalvar.disabled = true;
                        btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

                        const response = await fetch('/api/novo-condominio', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(condominio)
                        });

                        const result = await response.json();

                        if (result.status === 'sucesso') {
                            alert('✅ Condomínio adicionado com sucesso!');
                            fecharModal();

                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            alert('❌ Erro: ' + result.mensagem);
                            btnSalvar.disabled = false;
                            btnSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar Condomínio';
                        }
                    } catch (error) {
                        alert('❌ Erro de conexão: ' + error.message);
                        const btnSalvar = document.querySelector('.btn-salvar');
                        btnSalvar.disabled = false;
                        btnSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar Condomínio';
                    }
                });
            }
        });
    </script>
    <script>
        // Adicionar índice para animação dos cards
        document.addEventListener('DOMContentLoaded', function () {
            // Animar cards de métricas
            const metricCards = document.querySelectorAll('.metric-card');
            metricCards.forEach((card, index) => {
                card.style.setProperty('--card-index', index);
            });

            // Animar cards de condomínios
            const condominioCards = document.querySelectorAll('.condominio-card');
            condominioCards.forEach((card, index) => {
                card.style.setProperty('--card-index', index);
            });

            // Adicionar efeito de clique nos botões
            document.querySelectorAll('button, .btn-action, .btn-add, .btn-primary').forEach(button => {
                button.addEventListener('click', function (e) {
                    // Adicionar efeito visual de clique
                    if (!this.classList.contains('disabled') && !this.disabled) {
                        this.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            this.style.transform = '';
                        }, 150);
                    }
                });
            });
        });
    </script>
</body>
</html>
